#############################################################################################################################################################################################
##############################################################################   一键到位  ################################################################################################
############################################################################################################################################################################################
Onestep_menu=(
     "一键设置环境变量"                'Onestep_Env'
     "一键部署V2ray服务器(含Nginx、X-ui、CFWarp、Tor)" 'Onestep_V2ray'
     "一键部署GPT潘多拉服务器(含Docker、ChatGPT-Pandora)" 'Onestep_GPT'
     "一键部署网盘管理工具(含Alist、Rclone)"          'Onestep_Drive'
     )  
#############################################################################################################################################################################################
##############################################################################   一键设置环境变量  ################################################################################################
############################################################################################################################################################################################

function Onestep_Env {

    echo -e "${BLUE}\n正在设置环境变量...${NC}"
    insert 'alias ll="ls -l"' "" "$path_nonloginEnv" 'alias ll="ls -l"'
    insert 'alias la="ls -al"' "" "$path_nonloginEnv" 'alias la="ls -al"'
    insert 'alias cls="clear"' "" "$path_nonloginEnv" 'alias cls="clear"'
    source "$path_nonloginEnv" && echo -e "${BLUE}\n已载入新环境变量！${NC}" || echo -e "${RED}\n环境变量载入错误，请检查！${NC}"

    echo -e "${BLUE}\n正在设置终端登录显示页面...${NC}"
    loginpagect='
欢迎进入我的Debian 11 云服务器远程控制系统~

上次登录信息:'
    cat > "$path_loginpageEnv" <<< "$loginpagect" && echo -e "${BLUE}\n已将登录页面设置为：${NC}" && echo "$loginpagect"

    echo -e "${BLUE}\n正在设置vim按键映射...${NC}"
    vimkey='
" 在vim启动时就进入插入模式
autocmd VimEnter * startinsert
" 保存文件
inoremap <C-s> <C-o>:w<CR>
" 退出vim(若未保存,则无法退出)
inoremap <C-w> <C-o>:q<CR>
" 退出vimm(若未保存,则提示)
inoremap <C-q> <C-o>:confirm q<CR>
" 撤销上一个动作
inoremap <C-z> <C-o>:u<CR>
" 恢复上一个动作
inoremap <C-r> <C-o>:redo<CR>
"屏幕向上移动半页
inoremap <C-u> <C-o><C-u>
"屏幕向下移动半页
inoremap <C-j> <C-o><C-d>
"光标移动到所在页行首
inoremap <C-h> <C-o>0
"光标移动到所在页行末
inoremap <C-k> <C-o>$
"搜索
inoremap <C-f> /
"删除光标所在字符到该列行尾的所有数据
inoremap <C-p> <C-o>d$
"删除光标所在字符到该列行首的所有数据
inoremap <C-o> <C-o>d0
'
    cat > "$path_vimEnv" <<< "$vimkey" && echo -e "${BLUE}\n已设置Vim按键映射为：${NC}" && echo "$vimkey"

    echo -e "${BLUE}\n已完成环境部署设置！${NC}"
}

#############################################################################################################################################################################################
##############################################################################   一键部署V2ray服务器  ################################################################################################
############################################################################################################################################################################################
function Onestep_V2ray {
    echo -e "${BLUE}即将开始一键部署V2ray服务器${NC}"
    echo
    echo -e "${BLUE}请到 $data_path 目录中导入个人配置（如需），导入完成后方可继续 ${NC}"
    wait
    echo
    echo -e "${BLUE}开始安装Nginx...${NC}"
    install_Nginx 
    echo
    echo -e "${BLUE}请到 /etc/nginx/conf.d 目录中导入Nginx配置，导入完成后方可继续 ${NC}"
    wait
    echo
    echo -e "${BLUE}开始安装X-ui...${NC}"
    local xui_port="15155"
    echo -e "${BLUE}参数提示：\n建议端口:$xui_port\n${NC}"
    install_Xui
    echo
    echo -e "${BLUE}即将开始DNS解析设置，请填写\确认参数${NC}"
    set_cfdns
    echo
    echo -e "${BLUE}请将www域名与本机ip绑定(为确保安全，需启动CDN)，绑定完成后返回继续${NC}"
    wait && echo "正在启动DNS管理器，请稍候..."
    echo 
    cfdns
    echo
    echo -e "${BLUE}即将开始申请SSL证书,申请完成后可继续选择安装BBR加速，并返回继续${NC}"
    echo -e "参数提示：\n域名:\n${Domain}\nAPI密钥:\n${Cloudflare_api_key}\n邮箱:\n${CFemail}\n"
    x-ui 
    echo 
    echo -e "${BLUE}即将重启Nginx,并载入新配置...${NC}"
    systemctl restart nginx
    echo 
    echo -e "${BLUE}开始xui面板及v2ray参数配置...${NC}"
    ufw allow $xui_port
    echo "UFW防火墙已暂时开放$xui_port端口，请前往 http://$(hostname -I | cut -d ' ' -f1):$xui_port 按提示顺序进行设置！设置完成后方可继续 "
    echo -e "${BLUE}提示：\n1、在 系统状态 中：建议版本切换至v1.7.5\n2、新建入站协议：vless\n3、监听ip：127.0.0.1\n4、端口：16166\n5、ID:随机\n6、传输协议：ws\n7、路径：/ray-vf2cre7st3onv8abv3v\n8、其余选项保持默认\n9、在 面板设置中：在xray 相关设置中导入v2ray配置模板（用于warp、tor）\n10、面板url根路径:/xui-vf2cre7st3onv8abv3v/\n11、保存配置并重启面板${NC}"
    echo "设置完成并重启后，即可前往 https://www.${Domain}/xui-vf2cre7st3onv8abv3v 继续使用xui面板！ "
    wait
    ufw delete allow $xui_port && echo "防火墙已关闭$xui_port端口"
    echo
    echo -e "${BLUE}开始安装Warp...${NC}"
    install_Warp
    echo
    echo -e "${BLUE}即将开始配置Tor，请填写\确认参数${NC}"
    set_dat "Tor_port"
    echo
    echo -e "${BLUE}开始安装Tor...${NC}"
    install_Tor 
    echo
    echo "ufw防火墙端口规则如下"
    ufw status verbose
    echo
    echo -e "${BLUE}恭喜，已完成V2ray服务器一键部署,开始畅享使用服务器吧！${NC}"
    echo 
}

#############################################################################################################################################################################################
##############################################################################   一键部署GPT潘多拉服务器  ################################################################################################
############################################################################################################################################################################################
function Onestep_GPT {
    echo -e "${BLUE}即将开始一键部署GPT潘多拉服务器${NC}"
    echo 
    echo -e "${BLUE}开始安装Docker...${NC}"
    install_Docker
    echo
    confirm "是否删除当前所有Docker容器？" "已取消删除容器" || ( docker stop $(docker ps -a -q) &&  docker rm $(docker ps -a -q) && echo "已删除所有容器" )
    echo
    echo -e "${BLUE}开始下载/更新镜像文件..${NC}"
    pull_Pandora
    echo -e "${BLUE}即将开始配置设置，请填写\确认参数${NC}"
    set_dat "Pandora_port"
    echo 
    echo -e "${BLUE}请将gpt域名与本机ip绑定(为确保安全，需启动CDN)，绑定完成后返回继续${NC}"
    wait && echo "正在启动DNS管理器，请稍候..."
    echo 
    cfdns
    echo 
    echo -e "${BLUE}准备启动GPT潘多拉服务器${NC}"
    run_Pandora && echo -e "\n${BLUE}已成功启动GPT潘多拉服务器！请前往https://gpt.${Domain} 进行使用！${NC}"
}
#############################################################################################################################################################################################
##############################################################################   一键部署网盘管理  ################################################################################################
############################################################################################################################################################################################
function Onestep_Drive {
    echo "维护中"
}
